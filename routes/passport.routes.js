var express = require('express');
var Usuario = require('../models/usuario.modelo');
var router = express.Router();
/////////////AUTHENTICATE------------------------------------------------------------------------------------------------------------------------------
var isAuthenticated = function(req, res, next) {
  if(req.isAuthenticated()) return next();
  res.redirect('/');
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
module.exports = function(passport) {
  /////////////LOGIN-GET-----------------------------------------------------------------------------------------------------------------------------
  /* GET login page. */
  router.get('/login', function(req, res) {
    if(!req.usuario) {
      res.render('sigin', {
        titulo: 'Formula Identificacion',
        mensajes: req.flash('error') || req.flash('info')
      });
    } else {
      return res.redirect('/index');
    }
  });
  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  /////////////LOGIN-POST-----------------------------------------------------------------------------------------------------------------------------
  /* Handle Login POST */
  router.post('/login', passport.authenticate('local', {
    successFlash: 'Welcome!'
  }), function(req, res) {
    // If this function gets called, authentication was successful.
    // `req.user` contains the authenticated user.
    res.status(200);
    return res.send(req.user);
  });
  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  /////////////SIGNUP-GET-----------------------------------------------------------------------------------------------------------------------------
  /* GET Registration Page */
  router.get('/signup', function(req, res, next) {
    if(!req.usuario) {
      res.render('signup', {
        titulo: 'Formulario Registro',
        mensajes: req.flash('error') || req.flash('info')
      });
    } else {
      res.redirect('/index');
    }
  });
  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  /////////////SIGNUP-POST-----------------------------------------------------------------------------------------------------------------------------
  router.post('/signup', (req, res, next) => {
    if(!req.usuario) {
      console.log(req.body);
      var usuario = new Usuario(req.body);
      var mensaje = null;
      usuario.proveedor = 'local';
      console.log(usuario);
      usuario.save(function(err, user) {
        if(err) {
          console.log(err);
          req.flash('error', mensaje);
          res.send(err);
        }
        if(user) {
          res.status(200);
          return res.send("OK");
        }
        /*  req.login(usuario, function(err) {
            if(err) return next(err);
            //res.status(200);
            return res.send('Usuario Autenticado.')
          });*/
      });
    } else {
      //res.status(404);
      return res.send('Error usuario ya logeado.');
    }
  });
  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  /////////////SIGNOUT------------------------------------------------------------------------------------------------------------------------------
  /* Handle Logout */
  router.get('/logout', function(req, res, next) {
    req.logout();
    res.status(200);
    return res.send('LOGOUT');
  });
  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  /////////////********------------------------------------------------------------------------------------------------------------------------------
  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  /////////////********------------------------------------------------------------------------------------------------------------------------------
  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  /////////////********------------------------------------------------------------------------------------------------------------------------------
  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  /////////////********------------------------------------------------------------------------------------------------------------------------------
  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  return router;
}
