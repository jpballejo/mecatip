var express = require('express');
var Usuario = require('../models/usuario.modelo');
var router = express.Router();
var jwt = require('jsonwebtoken');
var jwtSecret = require('../passport/jwtConfig');
var jwt = require('jsonwebtoken');
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
module.exports = function(passport) {
  /////////////LOGIN-POST-----------------------------------------------------------------------------------------------------------------------------

  router.post('/login', passport.authenticate('local', {
    session: false
  }), function(req, res) {
    userT = {
            username: req.user.username
    }
    const token = jwt.sign(userT, jwtSecret.secret);
    userT.token = token;
    res.json(userT);
  });
  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  /////////////SIGNUP-POST-----------------------------------------------------------------------------------------------------------------------------
  router.post('/signup', (req, res, next) => {
    if(!req.usuario) {
      console.log(req.body);
      var usuario = new Usuario(req.body);
      var mensaje = null;
      usuario.proveedor = 'local';
      console.log(usuario);
      usuario.save(function(err, user) {
        if(err) {
          console.log(err);
          res.send(err);
        }
        if(user) {
          req.login(user, () => {
            userT = {

              username: user.username

            };
            const nToken = jwt.sign(userT, jwtSecret.secret);
            userT.token = nToken;
          });
          return res.send(userT);
        }

      });
    } else {

      return res.send('Error usuario ya logeado.');
    }
  });
  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  /////////////SIGNOUT------------------------------------------------------------------------------------------------------------------------------

  router.get('/logout', function(req, res, next) {
    req.logout();

    return res.send('LOGOUT');
  });
  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  /////////////********------------------------------------------------------------------------------------------------------------------------------
  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  /////////////********------------------------------------------------------------------------------------------------------------------------------
  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  /////////////********------------------------------------------------------------------------------------------------------------------------------
  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  /////////////********------------------------------------------------------------------------------------------------------------------------------
  //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
  return router;
}
